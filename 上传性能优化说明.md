# 上传性能优化说明

## 已实施的优化

### 1. 前端优化
- ✅ **文件级别并发**：最多同时上传 6 个文件
- ✅ **分片级别并发**：每个文件内部分片最多同时上传 5 个
- ✅ **动态分片大小**：
  - 超大文件（>200MB）：50MB/片
  - 大文件（100-200MB）：30MB/片
  - 中大文件（50-100MB）：20MB/片
  - 中文件（20-50MB）：10MB/片
  - 小文件（<20MB）：5MB/片
- ✅ **小文件直接上传**：30MB以下文件不分片，直接上传
- ✅ **超时优化**：增加到 300 秒

### 2. 后端优化
- ✅ **流式合并**：使用 1MB 读取块，提升合并速度
- ✅ **智能等待**：动态等待时间，前5秒快速检查
- ✅ **异步七牛云上传**：不阻塞主流程
- ✅ **自动删除本地文件**：上传成功后自动删除，节省存储空间

## 如果仍然很慢，请检查以下配置

### 1. PHP 配置检查

编辑 `php.ini` 文件：

```ini
# 上传文件大小限制
upload_max_filesize = 100M
post_max_size = 100M

# 内存限制
memory_limit = 256M

# 执行时间限制
max_execution_time = 300
max_input_time = 300

# 文件上传相关
file_uploads = On
```

**修改后重启 PHP-FPM**：
```bash
# Windows (phpstudy)
# 在phpstudy控制面板中重启PHP-FPM

# Linux
systemctl restart php-fpm
```

### 2. Nginx 配置检查

编辑 Nginx 配置文件（如 `/etc/nginx/nginx.conf` 或站点配置文件）：

```nginx
http {
    # 客户端请求体大小限制
    client_max_body_size 100M;
    
    # 超时设置
    client_body_timeout 300s;
    client_header_timeout 300s;
    
    # 代理超时（如果使用反向代理）
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
}

server {
    # FastCGI 超时设置
    fastcgi_connect_timeout 300s;
    fastcgi_send_timeout 300s;
    fastcgi_read_timeout 300s;
    
    # 请求体缓冲区大小
    client_body_buffer_size 128k;
}
```

**修改后重启 Nginx**：
```bash
nginx -t  # 检查配置
nginx -s reload  # 重新加载配置
```

### 3. Apache 配置检查

编辑 Apache 配置文件：

```apache
# 请求体大小限制
LimitRequestBody 104857600  # 100MB

# 超时设置
TimeOut 300
```

**修改后重启 Apache**：
```bash
# Windows
# 在phpstudy控制面板中重启Apache

# Linux
systemctl restart apache2
```

### 4. 网络速度检查

**检查服务器带宽**：
```bash
# 检查网络速度
curl -o /dev/null -s -w "上传速度: %{speed_upload} bytes/s\n下载速度: %{speed_download} bytes/s\n" http://speedtest.tele2.net/10MB.zip
```

**检查七牛云上传速度**：
- 登录七牛云控制台
- 检查空间的上传速度和CDN速度
- 确认空间区域是否正确（建议选择距离服务器最近的区域）

### 5. 服务器性能检查

**检查磁盘IO**：
```bash
# Linux
iostat -x 1

# 检查磁盘使用率
df -h
```

**检查CPU和内存**：
```bash
# Linux
top
htop
```

### 6. 代码层面的进一步优化

如果以上配置都已优化但仍慢，可以尝试：

1. **增加并发度**：修改 `MAX_CONCURRENT_FILES` 和 `maxConcurrentChunks`
2. **增大分片大小**：进一步减少分片数量
3. **使用队列**：将上传任务放入队列异步处理
4. **使用对象存储直传**：让前端直接上传到七牛云，不经过服务器

## 性能测试

### 测试上传速度

1. **单个文件测试**：上传一个50MB的视频，记录时间
2. **批量文件测试**：上传8个文件，记录总时间
3. **监控网络使用**：使用浏览器开发者工具监控网络请求

### 预期性能

- **小文件（<30MB）**：直接上传，应该很快
- **中文件（30-100MB）**：分片上传，5-10分片，并发上传应该较快
- **大文件（>100MB）**：分片上传，分片数少，应该较快

## 常见问题

### Q: 为什么88%的时候特别慢？

A: 可能的原因：
1. 最后一个分片包含封面上传
2. 等待所有分片上传完成
3. 后端分片合并处理慢
4. 七牛云上传慢

**解决方案**：
- 已优化：七牛云上传改为异步，不阻塞最后一个分片
- 已优化：增大了读取块大小，加快合并速度
- 已优化：减少了等待时间

### Q: 如何进一步提升速度？

A: 可以尝试：
1. 使用七牛云直传（前端直接上传到七牛云，不经过服务器）
2. 使用CDN加速
3. 增加服务器带宽
4. 优化网络路径

### Q: 上传失败怎么办？

A: 检查：
1. 查看日志：`runtime/log/日期.log`
2. 检查服务器配置（见上方）
3. 检查网络连接
4. 检查文件权限

## 监控和调试

### 查看上传日志

```bash
# Windows
type runtime\log\202411\20.log | findstr "上传"

# Linux
tail -f runtime/log/202411/20.log | grep "上传"
```

### 查看错误日志

```bash
# Windows
type runtime\log\202411\20.log | findstr "错误\|失败"

# Linux
tail -f runtime/log/202411/20.log | grep -i "error\|fail"
```

### 使用浏览器开发者工具

1. 打开浏览器开发者工具（F12）
2. 切换到 Network（网络）标签
3. 开始上传文件
4. 查看请求时间、大小、状态
5. 识别慢的请求

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 上传的文件数量和大小
2. 服务器配置信息
3. 网络速度测试结果
4. 浏览器开发者工具的网络请求截图
5. 服务器错误日志

