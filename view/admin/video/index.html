{extend name="admin/common/layout" /}

{block name="title"}视频管理{/block}
{block name="page_title"}视频管理{/block}
{block name="page_actions"}
<a href="/admin.php/video/batchUpload" class="btn btn-success btn-sm">
    <i class="fas fa-cloud-upload-alt mr-1"></i> 批量上传
</a>
<button type="button" class="btn btn-warning btn-sm js-batch-edit">
    <i class="fas fa-edit mr-1"></i> 批量编辑
</button>
<button type="button" class="btn btn-danger btn-sm js-batch-delete">
    <i class="fas fa-trash-alt mr-1"></i> 批量删除
</button>
{/block}

{block name="content"}
<div class="card shadow-sm">
    <div class="card-body">
        <form method="get" class="form-row align-items-center mb-3">
            <div class="col-lg-3 col-md-4 mb-2">
                <select name="platform_id" class="form-control form-control-sm">
                    <option value="">全部平台</option>
                    {volist name="platforms" id="platform"}
                    <option value="{$platform.id}" {if $platform_id == $platform.id}selected{/if}>{$platform.name}</option>
                    {/volist}
                </select>
            </div>
            <div class="col-lg-3 col-md-4 mb-2">
                <select name="device_id" class="form-control form-control-sm">
                    <option value="">全部设备</option>
                    {volist name="devices" id="device"}
                    <option value="{$device.id}" {if $device_id == $device.id}selected{/if}>{$device.device_name}</option>
                    {/volist}
                </select>
            </div>
            <div class="col-lg-2 col-md-4 mb-2">
                <select name="is_downloaded" class="form-control form-control-sm">
                    <option value="-1" {if $is_downloaded==-1}selected{/if}>下载状态</option>
                    <option value="0" {if $is_downloaded==0}selected{/if}>未下载</option>
                    <option value="1" {if $is_downloaded==1}selected{/if}>已下载</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6 mb-2">
                <input type="text" name="keyword" value="{$keyword|default=''}" class="form-control form-control-sm" placeholder="搜索标题或视频链接">
            </div>
            <div class="col-md-2 col-6 mb-2">
                <button type="submit" class="btn btn-primary btn-sm btn-block">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div class="col-md-2 col-6 mb-2">
                <a href="/admin.php/video" class="btn btn-outline-secondary btn-sm btn-block">
                    <i class="fas fa-undo"></i>
                </a>
            </div>
        </form>

        {if count($list)}
        <div class="table-responsive">
            <table class="table table-hover table-striped text-nowrap align-middle">
                <thead class="thead-light">
                    <tr>
                        <th width="40"><input type="checkbox" id="checkAll"></th>
                        <th>ID</th>
                        <th>标题</th>
                        <th>平台 / 设备</th>
                        <th>封面</th>
                        <th>下载状态</th>
                        <th>创建时间</th>
                        <th class="text-right">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {volist name="list" id="item"}
                    <tr>
                        <td><input type="checkbox" class="check-item" value="{$item.id}"></td>
                        <td>{$item.id}</td>
                        <td class="font-weight-bold" style="max-width:260px; white-space:normal;">
                            {$item.title|default='—'}
                            <div class="text-muted small">{$item.video_url}</div>
                        </td>
                        <td>
                            <div>{$item.platform.name|default='—'}</div>
                            <div class="text-muted small">{$item.device.device_name|default='—'}</div>
                        </td>
                        <td>
                            {if !empty($item.cover_url)}
                            <img src="{$item.cover_url}" alt="封面" class="img-thumbnail" style="max-width:96px; max-height:60px; object-fit:cover;">
                            {else /}<span class="text-muted">—</span>{/if}
                        </td>
                        <td>
                            {if $item.is_downloaded == 1}
                            <span class="badge badge-success">已下载</span>
                            {else}
                            <span class="badge badge-warning">未下载</span>
                            {/if}
                        </td>
                        <td>{$item.created_at|default='—'}</td>
                        <td class="text-right">
                            <div class="btn-group btn-group-sm">
                                <a href="/admin.php/video/edit/{$item.id}" class="btn btn-outline-info">
                                    <i class="fas fa-edit"></i> 编辑
                                </a>
                                <button type="button" class="btn btn-outline-danger js-delete" data-id="{$item.id}" data-title="{$item.title|default='视频'}">
                                    <i class="fas fa-trash-alt"></i> 删除
                                </button>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            {$list->render()|raw}
        </div>
        {else /}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-2x mb-3"></i>
            <p class="mb-1">暂无视频数据</p>
            <p class="small">尝试调整筛选条件或前往批量上传。</p>
        </div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
    function getCheckedIds() {
        const ids = [];
        $('.check-item:checked').each(function () { ids.push($(this).val()); });
        return ids;
    }

    $(function () {
        $('#checkAll').on('change', function () {
            $('.check-item').prop('checked', $(this).prop('checked'));
        });

        $('.js-delete').on('click', function () {
            const id = $(this).data('id');
            const title = $(this).data('title');
            AdminUI.confirm(`确定要删除视频「${title}」吗？`, function () {
                $.post(`/admin.php/video/delete/${id}`, {}, function (res) {
                    if (res.code === 0) {
                        AdminUI.showToast('success', res.msg || '删除成功');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        AdminUI.showToast('error', res.msg || '删除失败');
                    }
                }).fail(function () {
                    AdminUI.showToast('error', '删除失败，请稍后再试');
                });
            });
        });

        $('.js-batch-edit').on('click', function () {
            const ids = getCheckedIds();
            if (!ids.length) {
                AdminUI.showToast('warning', '请先勾选需要编辑的视频');
                return;
            }
            window.location.href = '/admin.php/video/batchEdit?ids=' + ids.join(',');
        });

        $('.js-batch-delete').on('click', function () {
            const ids = getCheckedIds();
            if (!ids.length) {
                AdminUI.showToast('warning', '请先勾选需要删除的视频');
                return;
            }
            AdminUI.confirm(`确定要删除选中的 ${ids.length} 个视频吗？`, function () {
                $.post('/admin.php/video/batchDelete', { ids: ids }, function (res) {
                    if (res.code === 0) {
                        AdminUI.showToast('success', res.msg || '删除成功');
                        setTimeout(() => window.location.reload(), 1200);
                    } else {
                        AdminUI.showToast('error', res.msg || '删除失败');
                    }
                }).fail(function () {
                    AdminUI.showToast('error', '删除失败，请稍后再试');
                });
            });
        });
    });
</script>
{/block}
