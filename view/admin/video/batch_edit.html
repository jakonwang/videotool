{extend name="admin/common/layout" /}

{block name="title"}批量编辑视频{/block}
{block name="page_title"}批量编辑视频{/block}
{block name="breadcrumb"}<a href="/admin.php/video" class="text-muted">视频管理</a> / 批量编辑{/block}
{block name="page_actions"}
<a href="/admin.php/video" class="btn btn-outline-secondary btn-sm">
    <i class="fas fa-arrow-left mr-1"></i> 返回列表
</a>
{/block}

{block name="content"}
<form id="editForm">
    <input type="hidden" name="ids" value="{$ids_str}">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">批量修改 <small class="text-muted">共 {$count} 条</small></h3>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle mr-1"></i> 输入新的标题后，系统将统一更新所选视频。
            </div>
            <div class="form-group">
                <label for="title">批量修改标题 <span class="text-danger">*</span></label>
                <textarea name="title" id="title" class="form-control" rows="3" required placeholder="输入新的标题，将统一修改所有选中视频的标题"></textarea>
                <small class="form-text text-muted">将统一修改所有选中视频的标题为以上内容。</small>
            </div>
            <hr>
            <h5>视频列表预览</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>标题</th>
                            <th>封面</th>
                            <th>设备</th>
                        </tr>
                    </thead>
                    <tbody>
                        {volist name="list" id="video"}
                        <tr>
                            <td>{$video.id}</td>
                            <td>{$video.title|mb_substr=0,50,'utf-8'}{if mb_strlen($video.title, 'utf-8') > 50}...{/if}</td>
                            <td>
                                {if $video.cover_url}
                                <img src="{$video.cover_url}" style="max-width:80px; max-height:50px; object-fit:cover;" onerror="this.style.display='none'">
                                {else /}
                                <span class="text-muted">无封面</span>
                                {/if}
                            </td>
                            <td>{if isset($video.device)}{$video.device.device_name}{else}未知设备{/if}</td>
                        </tr>
                        {/volist}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-right">
            <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-save mr-1"></i> 保存修改</button>
            <a href="/admin.php/video" class="btn btn-outline-secondary"><i class="fas fa-times mr-1"></i> 取消</a>
        </div>
    </div>
</form>
{/block}

{block name="script"}
<script>
    $('#editForm').on('submit', function (e) {
        e.preventDefault();
        const title = $('#title').val().trim();
        if (!title) {
            AdminUI.showToast('warning', '请输入要修改的标题');
            return;
        }
        const $btn = $(this).find('button[type="submit"]');
        const originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm mr-1" role="status"></span>保存中');
        $.post('/admin.php/video/batchEdit', $(this).serialize())
            .done(function (res) {
                if (res && res.code === 0) {
                    AdminUI.showToast('success', res.msg || '保存成功');
                    setTimeout(() => window.location.href = '/admin.php/video', 800);
                } else {
                    AdminUI.showToast('error', res.msg || '保存失败');
                    $btn.prop('disabled', false).html(originalHtml);
                }
            })
            .fail(function () {
                AdminUI.showToast('error', '保存失败，请稍后再试');
                $btn.prop('disabled', false).html(originalHtml);
            });
    });
</script>
{/block}
