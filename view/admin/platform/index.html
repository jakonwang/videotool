{extend name="admin/common/layout" /}

{block name="title"}平台管理{/block}
{block name="page_title"}平台管理{/block}
{block name="page_actions"}
<a href="/admin.php/platform/add" class="btn btn-primary btn-sm">
    <i class="fas fa-plus mr-1"></i> 添加平台
</a>
{/block}

{block name="content"}
<div class="card shadow-sm">
    <div class="card-body">
        <form method="get" class="form-row align-items-center mb-3">
            <div class="col-md-4 mb-2">
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" id="keyword" name="keyword" value="{$keyword|default=''}" class="form-control" placeholder="搜索名称或代码">
                </div>
            </div>
            <div class="col-md-3 mb-2">
                <select name="status" id="status" class="form-control form-control-sm">
                    <option value="">全部状态</option>
                    <option value="1" {if $status==='1'}selected{/if}>启用</option>
                    <option value="0" {if $status==='0'}selected{/if}>禁用</option>
                </select>
            </div>
            <div class="col-md-2 col-6 mb-2">
                <button type="submit" class="btn btn-primary btn-sm btn-block">
                    <i class="fas fa-filter mr-1"></i>筛选
                </button>
            </div>
            <div class="col-md-2 col-6 mb-2">
                <a href="/admin.php/platform" class="btn btn-outline-secondary btn-sm btn-block">
                    <i class="fas fa-undo mr-1"></i>重置
                </a>
            </div>
        </form>

        {if count($list)}
        <div class="table-responsive">
            <table class="table table-hover table-striped text-nowrap">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>平台名称</th>
                        <th>平台代码</th>
                        <th>图标</th>
                        <th>访问链接</th>
                        <th class="text-center">状态</th>
                        <th>创建时间</th>
                        <th class="text-right">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {volist name="list" id="item"}
                    <tr>
                        <td>{$item.id}</td>
                        <td class="font-weight-bold">{$item.name}</td>
                        <td><code>{$item.code}</code></td>
                        <td>{$item.icon|raw|default='<span class="text-muted">—</span>'}</td>
                        <td style="min-width:280px;">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control platform-link" value="{$base_url}?platform={$item.code}" readonly data-id="{$item.id}">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary btn-sm js-copy-link" data-link="{$base_url}?platform={$item.code}">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <a href="{$base_url}?platform={$item.code}" target="_blank" class="btn btn-outline-primary btn-sm" title="新窗口打开">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            {if $item.status == 1}
                            <span class="badge badge-success">启用</span>
                            {else}
                            <span class="badge badge-secondary">禁用</span>
                            {/if}
                        </td>
                        <td>{$item.created_at|default='—'}</td>
                        <td class="text-right">
                            <div class="btn-group btn-group-sm">
                                <a href="/admin.php/platform/edit/{$item.id}" class="btn btn-outline-info">
                                    <i class="fas fa-edit"></i> 编辑
                                </a>
                                <button type="button"
                                        class="btn btn-outline-danger js-delete"
                                        data-id="{$item.id}"
                                        data-name="{$item.name}">
                                    <i class="fas fa-trash-alt"></i> 删除
                                </button>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            {$list|raw}
        </div>
        {else /}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-2x mb-3"></i>
            <p class="mb-1">暂无平台数据</p>
            <p class="small">点击右上角“添加平台”创建第一条记录。</p>
        </div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
    $(function () {
        $('.js-copy-link').on('click', function () {
            const link = $(this).data('link');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    AdminUI.showToast('success', '链接已复制');
                }).catch(() => {
                    AdminUI.showToast('error', '复制失败，请手动复制');
                });
            } else {
                AdminUI.showToast('warning', '浏览器不支持剪贴板，请手动复制');
            }
        });

        $('.js-delete').on('click', function () {
            const id = $(this).data('id');
            const name = $(this).data('name');
            AdminUI.confirm(`确定要删除平台「${name}」吗？删除后关联的设备与视频将一并移除。`, function () {
                $.post(`/admin.php/platform/delete/${id}`, {}, function (res) {
                    if (res.code === 0) {
                        AdminUI.showToast('success', res.msg || '删除成功');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        AdminUI.showToast('error', res.msg || '删除失败');
                    }
                }).fail(function () {
                    AdminUI.showToast('error', '删除失败，请稍后再试');
                });
            });
        });
    });
</script>
{/block}
