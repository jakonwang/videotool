{extend name="admin/common/layout" /}

{block name="title"}设备管理{/block}
{block name="page_title"}设备管理{/block}
{block name="page_actions"}
<a href="/admin.php/device/add" class="btn btn-primary btn-sm">
    <i class="fas fa-plus mr-1"></i> 添加设备
</a>
{/block}

{block name="content"}
<div class="card shadow-sm">
    <div class="card-body">
        <form method="get" class="form-row align-items-center mb-3">
            <div class="col-md-4 mb-2">
                <select name="platform_id" class="form-control form-control-sm">
                    <option value="">全部平台</option>
                    {volist name="platforms" id="platform"}
                    <option value="{$platform.id}" {if $platform_id == $platform.id}selected{/if}>{$platform.name}</option>
                    {/volist}
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <select name="status" class="form-control form-control-sm">
                    <option value="">全部状态</option>
                    <option value="1" {if $status==='1'}selected{/if}>启用</option>
                    <option value="0" {if $status==='0'}selected{/if}>禁用</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <input type="text" name="keyword" value="{$keyword|default=''}" class="form-control form-control-sm" placeholder="搜索设备名称或 IP">
            </div>
            <div class="col-md-1 col-6 mb-2">
                <button type="submit" class="btn btn-primary btn-sm btn-block">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div class="col-md-1 col-6 mb-2">
                <a href="/admin.php/device" class="btn btn-outline-secondary btn-sm btn-block">
                    <i class="fas fa-undo"></i>
                </a>
            </div>
        </form>

        {if count($list)}
        <div class="table-responsive">
            <table class="table table-hover table-striped text-nowrap">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>设备名称</th>
                        <th>所属平台</th>
                        <th>IP 地址</th>
                        <th class="text-center">状态</th>
                        <th>创建时间</th>
                        <th class="text-right">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {volist name="list" id="item"}
                    <tr>
                        <td>{$item.id}</td>
                        <td class="font-weight-bold">{$item.device_name|default='—'}</td>
                        <td>{$item.platform.name|default='—'}</td>
                        <td><code>{$item.ip_address|default='—'}</code></td>
                        <td class="text-center">
                            {if $item.status == 1}
                            <span class="badge badge-success">启用</span>
                            {else}
                            <span class="badge badge-secondary">禁用</span>
                            {/if}
                        </td>
                        <td>{$item.created_at|default='—'}</td>
                        <td class="text-right">
                            <div class="btn-group btn-group-sm">
                                <a href="/admin.php/device/edit/{$item.id}" class="btn btn-outline-info">
                                    <i class="fas fa-edit"></i> 编辑
                                </a>
                                <button type="button" class="btn btn-outline-danger js-delete" data-id="{$item.id}" data-name="{$item.device_name|default='设备'}">
                                    <i class="fas fa-trash-alt"></i> 删除
                                </button>
                            </div>
                        </td>
                    </tr>
                    {/volist}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            {$list->render()|raw}
        </div>
        {else /}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-2x mb-3"></i>
            <p class="mb-1">暂无设备数据</p>
            <p class="small">请先添加设备或调整筛选条件。</p>
        </div>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
    $(function () {
        $('.js-delete').on('click', function () {
            const id = $(this).data('id');
            const name = $(this).data('name');
            AdminUI.confirm(`确定要删除设备「${name}」吗？该设备下的所有视频也会被删除。`, function () {
                $.post(`/admin.php/device/delete/${id}`, {}, function (res) {
                    if (res.code === 0) {
                        AdminUI.showToast('success', res.msg || '删除成功');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        AdminUI.showToast('error', res.msg || '删除失败');
                    }
                }).fail(function () {
                    AdminUI.showToast('error', '删除失败，请稍后再试');
                });
            });
        });
    });
</script>
{/block}
