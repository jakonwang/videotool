{extend name="admin/common/layout" /}

{block name="title"}{if isset($info)}编辑设备{else}添加设备{/if}{/block}
{block name="page_title"}{if isset($info)}编辑设备{else}添加设备{/if}{/block}
{block name="breadcrumb"}<a href="/admin.php/device" class="text-muted">设备管理</a> / {if isset($info)}编辑{else}添加{/if}{/block}
{block name="page_actions"}
<a href="/admin.php/device" class="btn btn-outline-secondary btn-sm">
    <i class="fas fa-arrow-left mr-1"></i> 返回列表
</a>
{/block}

{block name="content"}
<div class="row">
    <div class="col-lg-7 col-xl-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="device-form" autocomplete="off">
                    {if isset($info)}<input type="hidden" name="id" value="{$info.id}">{/if}
                    <div class="form-group">
                        <label for="platform_id">所属平台 <span class="text-danger">*</span></label>
                        <select id="platform_id" name="platform_id" class="form-control" required>
                            <option value="">请选择平台</option>
                            {volist name="platforms" id="platform"}
                            <option value="{$platform.id}" {if isset($info) && $info.platform_id == $platform.id}selected{/if}>{$platform.name}</option>
                            {/volist}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ip_address">设备 IP <span class="text-danger">*</span></label>
                        <input type="text" id="ip_address" name="ip_address" class="form-control" value="{$info.ip_address|default=''}" placeholder="例如：192.168.1.100" required>
                        <small class="form-text text-muted">用于识别设备并分配视频。</small>
                    </div>
                    <div class="form-group">
                        <label for="device_name">设备名称</label>
                        <input type="text" id="device_name" name="device_name" class="form-control" value="{$info.device_name|default=''}" placeholder="例如：测试设备 A">
                        <small class="form-text text-muted">留空时系统会自动生成。</small>
                    </div>
                    <div class="form-group">
                        <label for="status">状态</label>
                        <select id="status" name="status" class="form-control">
                            <option value="1" {if isset($info) && $info.status == 1}selected{/if}>启用</option>
                            <option value="0" {if isset($info) && $info.status == 0}selected{/if}>禁用</option>
                        </select>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> 保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script>
    $(function () {
        $('#device-form').on('submit', function (event) {
            event.preventDefault();
            const $form = $(this);
            const submitBtn = $form.find('button[type="submit"]');
            const originalHtml = submitBtn.html();
            submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm mr-1" role="status"></span>保存中');
            const url = {if isset($info)}'/admin.php/device/edit/{$info.id}'{else}'/admin.php/device/add'{/if};
            $.post(url, $form.serialize())
                .done(function (res) {
                    if (res.code === 0) {
                        AdminUI.showToast('success', res.msg || '保存成功');
                        setTimeout(() => window.location.href = '/admin.php/device', 1000);
                    } else {
                        AdminUI.showToast('error', res.msg || '保存失败');
                    }
                })
                .fail(function () {
                    AdminUI.showToast('error', '保存失败，请稍后再试');
                })
                .always(function () {
                    submitBtn.prop('disabled', false).html(originalHtml);
                });
        });
    });
</script>
{/block}
