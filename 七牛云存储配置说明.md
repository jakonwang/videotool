# 七牛云存储配置说明

## 功能概述

系统已集成七牛云对象存储服务（OSS），支持将视频和封面图片自动上传到七牛云CDN，提升访问速度和稳定性。

## 功能特点

- ✅ **双存储策略**：本地备份 + 七牛云CDN
- ✅ **自动上传**：上传文件时自动同步到七牛云
- ✅ **智能回退**：七牛云上传失败时自动使用本地URL
- ✅ **无缝切换**：已启用七牛云时，优先使用CDN地址
- ✅ **零侵入**：不影响现有功能，可随时启用/禁用

## 配置步骤

### 1. 获取七牛云密钥

1. 登录 [七牛云控制台](https://portal.qiniu.com/)
2. 进入 **个人中心** > **密钥管理**
3. 获取 `AccessKey` 和 `SecretKey`

### 2. 创建存储空间

1. 进入 **对象存储** > **空间管理**
2. 点击 **新建空间**
3. 记录空间名称（Bucket）
4. 获取空间的外链域名（CDN域名）

### 3. 配置系统

编辑 `.env` 文件（如果不存在，在项目根目录创建）：

```env
[qiniu]
enabled = true
access_key = 你的AccessKey
secret_key = 你的SecretKey
bucket = 你的Bucket名称
domain = https://你的CDN域名
```

**注意**：
- `domain` 必须以 `http://` 或 `https://` 开头
- `domain` 不要带结尾斜杠
- 示例：`domain = https://cdn.example.com`

### 4. 安装SDK依赖

如果还没有安装七牛云SDK，运行：

```bash
# Windows
php composer.phar require qiniu/php-sdk:^7.11

# Linux
composer require qiniu/php-sdk:^7.11
```

### 5. 验证配置

1. 进入后台管理
2. 上传一个视频或封面
3. 检查数据库中 `cover_url` 和 `video_url` 字段
4. 如果已启用七牛云，URL应该是 `https://你的CDN域名/...`
5. 如果还是本地路径，检查配置和日志

## 配置说明

### 配置文件位置

配置文件：`config/qiniu.php`

```php
return [
    // 是否启用七牛云（设置为false则使用本地存储）
    'enabled' => env('qiniu.enabled', false),
    
    // Access Key
    'access_key' => env('qiniu.access_key', ''),
    
    // Secret Key
    'secret_key' => env('qiniu.secret_key', ''),
    
    // 存储空间名称（Bucket）
    'bucket' => env('qiniu.bucket', ''),
    
    // 访问域名（CDN域名，必须以http://或https://开头，不要带结尾斜杠）
    'domain' => env('qiniu.domain', ''),
];
```

### 环境变量配置（推荐）

在项目根目录创建或编辑 `.env` 文件：

```env
[qiniu]
enabled = true
access_key = YOUR_ACCESS_KEY
secret_key = YOUR_SECRET_KEY
bucket = YOUR_BUCKET_NAME
domain = https://your-cdn-domain.com
```

### 直接修改配置文件（不推荐）

直接编辑 `config/qiniu.php`：

```php
return [
    'enabled' => true,
    'access_key' => 'YOUR_ACCESS_KEY',
    'secret_key' => 'YOUR_SECRET_KEY',
    'bucket' => 'YOUR_BUCKET_NAME',
    'domain' => 'https://your-cdn-domain.com',
];
```

## 使用说明

### 启用七牛云

1. 配置 `.env` 文件或 `config/qiniu.php`
2. 设置 `enabled = true`
3. 填写正确的密钥、Bucket和域名
4. 上传文件时会自动同步到七牛云

### 禁用七牛云

设置 `enabled = false` 或清空配置，系统将使用本地存储。

### 文件存储路径

- **本地路径**：`/uploads/videos/20241120/file.mp4`
- **七牛云路径**：`videos/20241120/file.mp4`
- **七牛云URL**：`https://cdn.example.com/videos/20241120/file.mp4`

系统会自动将本地路径映射为七牛云路径。

## 功能说明

### 上传流程

1. **文件上传到本地**
   - 系统先将文件保存到 `public/uploads/` 目录
   - 保证本地备份，避免数据丢失

2. **同步到七牛云**（如果启用）
   - 自动将文件上传到七牛云
   - 上传成功后，数据库存储七牛云URL
   - 上传失败时，记录日志并使用本地URL

3. **数据库存储**
   - `cover_url` 和 `video_url` 字段存储最终URL
   - 如果启用七牛云且上传成功，存储CDN地址
   - 否则存储本地路径

### 支持的功能

- ✅ **批量上传**：支持批量上传视频和封面
- ✅ **单个编辑**：支持替换视频和封面
- ✅ **分片上传**：支持大文件分片上传
- ✅ **API返回**：API自动返回正确的URL（CDN或本地）

### 日志记录

七牛云相关操作会记录到日志：

- 成功：`runtime/log/日期.log`
- 失败：`runtime/log/日期.log`（WARNING级别）

查看日志示例：

```bash
# Windows
type runtime\log\202411\20.log | findstr "七牛云"

# Linux
tail -f runtime/log/202411/20.log | grep "七牛云"
```

## 故障排查

### 问题1：上传后还是本地URL

**可能原因**：
1. 七牛云未启用（`enabled = false`）
2. 配置错误（密钥、Bucket、域名不正确）
3. 网络问题导致上传失败

**解决方法**：
1. 检查 `.env` 或 `config/qiniu.php` 配置
2. 查看日志文件：`runtime/log/日期.log`
3. 验证七牛云密钥是否正确
4. 检查网络连接

### 问题2：提示"七牛云未配置或未启用"

**原因**：配置文件中 `enabled` 为 `false` 或配置项为空

**解决方法**：
1. 检查 `config/qiniu.php` 或 `.env` 配置
2. 确保 `access_key`、`secret_key`、`bucket` 都不为空

### 问题3：七牛云上传失败但本地保存成功

**原因**：这是正常情况，系统会回退到本地存储

**说明**：
- 文件已保存在本地，可以正常使用
- 检查日志了解失败原因
- 修复问题后，可以手动重新上传

### 问题4：API返回的URL无法访问

**可能原因**：
1. CDN域名配置错误
2. 七牛云空间权限设置错误
3. 域名未绑定到空间

**解决方法**：
1. 检查七牛云控制台的空间域名设置
2. 确保域名已正确绑定
3. 检查空间权限（公开读/私有读）

## 最佳实践

### 1. CDN加速

- 使用七牛云CDN域名，而非直接使用OSS域名
- 可以显著提升文件访问速度
- 减少服务器带宽压力

### 2. 域名绑定

- 在七牛云控制台绑定自定义域名
- 配置HTTPS证书
- 使用CDN加速

### 3. 空间权限

- **公开读**：适用于视频、图片等公开内容
- **私有读**：适用于需要鉴权的文件

### 4. 备份策略

- 系统已实现本地备份
- 建议定期备份七牛云空间
- 重要文件可配置跨区域复制

### 5. 监控告警

- 在七牛云控制台设置空间使用量告警
- 监控上传失败日志
- 定期检查存储空间使用情况

## 性能优化

### 1. 上传优化

- 大文件使用分片上传（已支持）
- 多个文件并发上传（批量上传已优化）

### 2. 访问优化

- 使用CDN域名访问文件
- 配置浏览器缓存策略
- 使用图片压缩和视频转码

### 3. 成本优化

- 合理设置存储类型（标准/低频/归档）
- 配置生命周期规则
- 定期清理不需要的文件

## 注意事项

1. **密钥安全**
   - 不要将密钥提交到Git仓库
   - 使用 `.env` 文件管理敏感配置
   - 确保 `.env` 在 `.gitignore` 中

2. **域名配置**
   - 域名必须正确配置
   - 建议使用HTTPS
   - 检查域名CNAME解析

3. **存储费用**
   - 注意七牛云的存储和流量费用
   - 合理规划存储空间大小
   - 设置告警避免超额

4. **兼容性**
   - 系统兼容本地存储和七牛云
   - 可以随时切换存储方式
   - 已上传的文件不受影响

## 相关文档

- [七牛云官方文档](https://developer.qiniu.com/)
- [ThinkPHP文件系统](https://www.kancloud.cn/manual/thinkphp6_0/1037644)
- [项目README](README.md)

## 更新日志

### v1.0.0 (2024-11-20)
- ✅ 集成七牛云存储服务
- ✅ 支持批量上传同步
- ✅ 支持单个编辑同步
- ✅ 支持分片上传同步
- ✅ 自动回退机制
- ✅ 日志记录功能

